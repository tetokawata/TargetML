---
title: "Nonparametric CATE: Estimation and Application"
subtitle: "機械学習の経済学への応用"
author: "川田恵介"
format:
  revealjs:
    html-math-method: katex
    css: styles.css
    incremental: true
    slide-number: true
execute: 
  message: false
  warning: false
  echo: false
  eval: true
bibliography: references.bib
---

## 内容

```{r}
pacman::p_load(
  tidyverse,
  recipes,
  rpart,
  DiagrammeR
)

Result <- arrow::read_parquet(
  "TempData/Comparison1921NuisanceTau.parquet"
)

X <- recipe(
  ~ Size + Distance + Reform + Tenure + Kenpei + Youseki + ZoneHouse + ZoneCommerce + ZoneFactory,
  arrow::read_parquet(
    "TempData/Comparison1921NuisanceTau.parquet"
    )
  ) |> 
  step_normalize(all_predictors()) |> 
  prep() |> 
  bake(new_data = NULL)

EstLinear <- function(b){
  Score <- Result$PredLinear
  Q <- quantile(
    Score,
    probs = b)
  PsuY <- 
    Q + 
    (1/b)*
    if_else(Score <= Q, 1, 0)*
    (Result$ScoreAIPW - Q)
  Temp <- fixest::feols(Y ~ 1,
                        tibble(Y = PsuY)) |> 
    generics::tidy() |> 
    mutate(Q = b) |> 
    mutate(Method = "Linear")
  return(Temp)
  }

EstSuperLearner <- function(b){
  Score <- Result$PredSL
  Q <- quantile(
    Score,
    probs = b)
  PsuY <- 
    Q + 
    (1/b)*
    if_else(Score <= Q, 1, 0)*
    (Result$ScoreAIPW - Q)
  Temp <- fixest::feols(Y ~ 1,
                        tibble(Y = PsuY)) |> 
    generics::tidy() |> 
    mutate(Q = b) |> 
    mutate(Method = "SuperLearner")
  return(Temp)
}

EstTree <- function(b){
  Score <- Result$PredTree
  TempQ <- unique(Score) |> sort()
  Q <- TempQ[b]
  b <- if_else(Q >= Score,1,0) |> 
    mean()
  PsuY <- 
    Q + 
    (1/b)*
    if_else(Score <= Q, 1, 0)*
    (Result$ScoreAIPW - Q)
  Temp <- fixest::feols(Y ~ 1,
                        tibble(Y = PsuY)) |> 
    generics::tidy() |> 
    mutate(Q = b) |> 
    mutate(Method = "Tree")
  return(Temp)
  }

SimData <- function(n){
  X <- runif(
    n,
    0,
    10)
  Tau <- X^3 - 200
  D <- sample(
    0:1,
    n,
    replace = TRUE)
  Y <- Tau*D + runif(n)
  Temp <- tibble(
    Y = Y,
    D = D,
    Tau = Tau,
    X = X
  )
  return(Temp)
}

```

前回: $\tau(X)=E[Y|D=1,X]-E[Y|D=0,X]$ のParametricな推定

1. $\tau(X)=E[Y|D=1,X]-E[Y|D=0,X]$ のNonparametricな推定

2. 予測への応用

3. "顕著な異質性を持つグループ"の発見と信頼区間計算

## ここまでのまとめ

- $\tau(X)$ の有限個の実数パラメータによる特徴づけ

    - $\tau(X)\simeq\beta_0$: Partialling-out/AIPW
    
    - $\tau(X)\simeq\beta_0+\beta_1X_1+..+\beta_LX_L$
    
- $\tau(X)$ をNonparametricに推定する手法はあるが、有益？

    - 一般に信頼区間計算が難しい
    
    - 他の手法と同様に、分析目標をハッキリさせる必要がある
    
## 応用

- 個人因果効果の予測: できれば意思決定を強力に支援

    - 限界原理に基づく意思決定: 因果効果を知る必要がある

- 顕著な異質性を持つグループの"発見"

    - 平気効果は正だが、負の影響を受けるグループは存在しないか？
    
    - とてつもなく大きな正の影響を受けるグループはいるか？

# 条件付き平均差の推定

- 比較研究におけるゴールの一つ

- 条件付きランダム化が成り立っているのであれば、”個人効果"の最善の予測

## R Learner

- $\tau(X)$ を(擬似的な)Nonparametric (LASSOやRandom Forestなど)に推定する一つの手法

- @nie2021

- Causal Forest [@wager2018; @athey2019]

  - 入門 & 応用 [@athey2019Application]

## Generalized Partial Linear Model

$$E[Y|D,X]=\beta_{\tau}(X)\times D+f(X)$$

- Partialing out

$$\underbrace{\bar Y}_{=Y-E[Y|X]}=\beta_{\tau}(X)\times\underbrace{\bar D}_{=D-E[D|X]} + u$$

- $E[u|D,X]=0$

## Population Risk Minimization

$$\min_{\beta_{\tau}(X)} E\bigr[(\bar Y - \beta(\tau)\times\bar D)^2\bigr]$$

- 無限大に大きなサンプルで丸暗記モデル推定 ($X$ のあらゆる組み合わせについてのサブサンプル推定) をした結果得られる推定値

## Empirical Risk Minimization

$$\min_{\beta_{\tau}(X)} \sum_{i}\bigr[(\bar Y_i - \beta_{\tau}(X)\times\bar D_i)^2\bigr]$$

- まともにやると、ほぼほぼ過剰適合

- 何らかの単純化が必要

    - 罰則付き線形モデル $\beta(\tau)\times\bar D$ を十分に多く複雑な交差項として、定式化
    
    - モデル集計: Random Forestなど
    
## Causal Forest

- Population Riskを以下のように書き換えられる

$$\min_{\beta_{\tau}(X)} E\bigr[(\bar Y - \beta(\tau)\times\bar D)^2\bigr]$$

$$=\min_{\beta_{\tau}(X)} E\bigr[\bigr(\frac{\bar Y}{\bar D} - \beta(\tau)\bigr)^2\times \bar D^2\bigr]$$

- $\bar Y/\bar D$ をTarget, $\bar D^2$ をSampling weightとしたRandom ForestやStacking

## Inference

- 推計誤差を評価できるか？

    - Causal Forestは一応可能、 $X$ が多いと無理

- 一般には難しい (不可能?)

- 多くの研究課題において、"too much"な目標かも

# Treatment Effect Risk

- @kallus2022a

- 大きな異質性があるグループが存在するかどうかを探索する

    - $\tau(X)$ の予測値 $s(X)$ をシグナルとして用いる

## Estimand

$$R(q)=E[\tau(X)|\tau(X)\le Q(\tau(X),q)]$$

- $Q(s(X),q) = s(X)$ の $q$分位点

    - $q$ は研究者が事前に（複数）指定
    
    - 多重検定の補正は現実的な選択肢

## Estimand

```{r}
tibble(
  X = seq(0,10,0.00001)
  ) |> 
  ggplot(
    aes(
      x = X
      )
    ) +
  theme_bw() +
  geom_hline(yintercept = 50,
             aes(color = "平均")
             ) +
  geom_hline(yintercept = 0) +
  stat_function(
    fun = function(x) x^3 - 200
    ) +
  annotate("text", 
           x = 5, 
           y = 100, 
           parse = TRUE,
           label = "X^3 - 200") +
  ylab("Tau(X)")
```

## Estimand

```{r}
TempSim <- function(q,n){
  Temp <- SimData(n)
  Q <- quantile(Temp$Tau,q)
  Fit <- fixest::feols(
    Tau ~ 1,
    Temp |> 
      filter(Q >= Tau)
  )
  TempData <- tibble(
    Est = Fit$coefficients,
    Q = q
  )
  return(TempData)
}

map_dfr(
  seq(0.05,1,0.05),
  function(q){TempSim(q,10000)}
  ) |> 
  ggplot(
    aes(
      y = Q,
      x = Est
    )
  ) +
  theme_bw() +
  geom_vline(xintercept = 0) +
  geom_point()
```


## Signal as signal

- @chernozhukov2020generic

- $\tau(X) \neq s(X)$ を受け入れる

    - 異質性についてのシグナル(にすぎない)とみなす

- シグナルの応用: 例えば Group Average Difference

    - $E[\tau(X)|Q(s(x),q)\ge s(X)]$

- 注意: $s(X)$ は母集団上で定義された（明確な解釈がある）ものとは見做さない

## 推定

- $s(X)$ は交差推定され、所与（非確率変数）とみなすのであれば、推定は容易

- $s(X)\ge Q(s(X),q)$ を満たす事例について、 AIPW推定などを行えばOK

## AIPW推定の応用

- 推定値 $=\sum_i \phi_i/N$

$$\phi_i=\frac{I(Q(\bar s,q))}{q}\times \phi_i^{AIPW}$$

$$\phi_i^{AIPW}=f_{Y}(1,X_i)-f_Y(0,X_i)$$

$$+\frac{D_i(Y_i-f_{Y}(1,X_i))}{f_D(X_i)}-\frac{(1-D_i)(Y_i-f_{Y}(0,X_i))}{1-f_D(X_i)}$$

## 交差推定の活用

- $s(X)$ を固定のルールとみなすには、交差推定が必要

    - （ランダムに分割された）別データで行う

- $f_{Y}(D,X),f_{D}(X)$ ももちろん交差推定が必要

## 推定フロー: 例

```{r EstimationFllow}
grViz("digraph dot {
      graph [rankdir = UB,color = crimson]
      edge [color=black]
      node [shape = rectangle, color = darkslategray]
      A [label = 'OriginalData']
      B [label = 'Estimate s (by ML)']
      C [label = 'Estimate main estimation']
      A -> B [label = 'Random Split']
      A -> C
      B -> C [label = 's']
      {rank = same;B;C}
      }")
```

## 具体的な推定手順

- $s$ の推定: 例えば R learner、あるいは$\phi^{AIPW}_{i}$ を"予測する"

    - Training データ内で

    1. $\phi^{AIPW}_i$ を算出 (Training データ内で交差検証)
    
    2. $E[\phi^{AIPW}|X]$ をStackingなどで推定

- メインの推定は、Testデータ内でAIPW推定

## 解釈

$$E[\tau(X)|Q(s(X),q)\ge s(X)]$$

$$\ge E[\tau(X)|Q(\tau(X),q)\ge \tau(X)]$$

- 下位qth サブグループ内での平均差の上限 (の推定値)

## Signal as Nuisance

- やっぱり$E[\tau(X)|Q(\tau(X),q)\ge \tau(X)]$ を推定したい

    - $s(X)$ という解釈困難な指数を用いた分析???

- 問題は一般に $s(X)\neq \tau(X)$

    - 乖離している可能性を考慮する必要がある

## Neyman's ohthogonalityの応用

- Neyman's ohthogonalityを満たすスコアを設定し、漸近的に$s(X)$ の推定誤差を無視できないか?

- @kallus2022a の推定値: $=\sum \phi_i/N$

$$\phi_i=\frac{I(Q(s,q)\ge s)}{q}\times\phi_i^{AIPW}$$

$$+\underbrace{\frac{q-I(Q(s,q)\ge s)}{q}Q(s,q)}_{Adjusted}$$

## 推定手順

- Signal as signal とほぼ同様

- Trainingデータで推定された$s$ を用いて、 $Q(s,q)$ も計算

- 最終推定において $s(X)$ の推定誤差を無視するには、 $s(X)$ が $\tau(X)$ の一致推定量かつ $n^{1/4}$ 以上の速度で収束 [@kallus2022a]

## @kallus2022a の例

- フランスにおける失業者への支援サービス主体を民間から公営に移行させる施作が再就職率に与える影響[@behaghel2014private]を再検証 

    - RCTにより正の平均効果を確認

- [Section 5: Figure 1-5](https://arxiv.org/abs/2201.05893)

    - 大きな異質性: 負の効果

# 例を用いた復習

- Research Question: 2019年と2021年において、"観察できる特徴が共通な"中古マンションの取引価格はどのように変化したのか

- Data: 2019年と2021年の全国の中古マンション取引データ

  - $Y:$ 取引価格
  
  - $D:$ 2021/2019
  
  - $X:$ 広さ、立地市区町村、駅からの距離、広さ、築年、建ぺい・容積率、都市区間、改装


## Linear Model

- 解釈が容易 & 信頼区間形成が容易なモデル

    - @semenova2021
    
- Effect Riskの推定としての解釈: $E[s(X)|X]$ を線形モデルで推定

## Example: Linear Model

```{r}
Q <- qnorm(1 - (0.05/(2*8)))

fixest::feols(
  Y ~ Size + Distance + Reform + Tenure + ZoneHouse + Youseki + Kenpei + ZoneCommerce + ZoneFactory,
  X |> 
    mutate(Y = Result$ScoreAIPW)
  ) |> 
  generics::tidy() |> 
  mutate(term = fct_rev(term)) |> 
  ggplot(
    aes(
      y = term,
      x = estimate,
      xmin = estimate - Q*std.error,
      xmax = estimate + Q*std.error
    )
  ) +
  theme_bw() +
  geom_pointrange(linewidth = 1) +
  geom_pointrange(
    aes(
      xmin = estimate - 1.96*std.error,
      xmax = estimate + 1.96*std.error
    ),
    linewidth = 1.5
  ) +
  geom_vline(xintercept = 0) +
  ylab("")
```


## Example: Stacking VS Linear

```{r}
CI <- qnorm(
  1 - (0.05/(2*19))
  )

map_dfr(
  seq(0.05,1,0.05),
  EstLinear
  ) |> 
  bind_rows(
    map_dfr(seq(0.05,1,0.05),
            EstSuperLearner
            )
    ) |> 
  mutate(
    Method = factor(
      Method,
      levels = c(
        "SuperLearner",
        "Linear"
        )
      )
  ) |> 
  ggplot(
    aes(x = Q,
        y = estimate,
        ymin = estimate - CI*std.error,
        ymax = estimate + CI*std.error
        )
    ) +
  theme_bw() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_ribbon(
    aes(fill = "Adjusted CI"),
    alpha = 0.5
    ) +
  geom_ribbon(
    aes(
      ymin = estimate - 1.96*std.error,
      ymax = estimate + 1.96*std.error,
      fill = "NonAdjusted CI"),
    alpha = 0.5
    ) +
  facet_wrap(~Method) +
  theme(legend.position = "bottom")
```

## Tree Model

- データ主導かつ解釈モデリングモデル: Tree, LASSOなど

    - Honest Tree [@athey2016] : Treeの形成を行うデータとサブグループ平均の推定を行うデータを分割する
    
- 一般に推定するパラメータの選択(Tree構築, 変数選択)を行うデータとパラメータ推定を行うデータを分ければ、**選択されたモデル**を前提に、信用できる信頼区間計算が可能 [@kuchibhotla2022]
    
    - 選択されたモデルと母集団の関係性は、一般に不明瞭
    
- Effect Riskの推定としての解釈: $E[s(X)|X]$ を予測木モデルで推定

## Example: Tree Model

```{r}
FitTree <- rpart(
  ScoreAIPW ~ Size + Distance + Reform + Tenure + Youseki + Kenpei + ZoneHouse + ZoneCommerce + ZoneFactory,
             Result,
             control = rpart::rpart.control(
               cp = 0,
               maxdepth = 2
             ),
             subset = Group == 1
             )

FitTree |> 
  rpart.plot::rpart.plot()
```

## Example: Tree Model

```{r}
TempGroup <- predict(
  FitTree,
  newdata = Result[Result$Group == 2,]) |> 
  round(2)

fixest::feols(
  Y ~ 0 + Group,
  tibble(Y = Result$ScoreAIPW[Result$Group == 2],
         Group = TempGroup |> factor())
  ) |> 
  generics::tidy() |> 
  mutate(term = fct_rev(term)) |> 
  ggplot(
    aes(
      y = term,
      x = estimate,
      xmin = estimate - Q*std.error,
      xmax = estimate + Q*std.error
    )
  ) +
  theme_bw() +
  geom_pointrange(linewidth = 1) +
  geom_pointrange(
    aes(
      xmin = estimate - 1.96*std.error,
      xmax = estimate + 1.96*std.error
    ),
    linewidth = 1.5
  ) +
  geom_vline(xintercept = 0) +
  ylab("")
```

## Example: Stacking VS Tree

```{r}
CI <- qnorm(
  1 - (0.05/(2*19))
  )

map_dfr(seq(0.05,1,0.05),
        EstSuperLearner
        ) |> 
  bind_rows(
    map_dfr(2:8,
            EstTree)
  ) |> 
  mutate(
    Method = factor(
      Method,
      levels = c(
        "SuperLearner",
        "Tree"
        )
      )
  ) |> 
  ggplot(
    aes(x = Q,
        y = estimate,
        ymin = estimate - CI*std.error,
        ymax = estimate + CI*std.error
        )
    ) +
  theme_bw() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_ribbon(
    aes(fill = "Adjusted CI"),
    alpha = 0.5
    ) +
  geom_ribbon(
    aes(
      ymin = estimate - 1.96*std.error,
      ymax = estimate + 1.96*std.error,
      fill = "NonAdjusted CI"),
    alpha = 0.5
    ) +
  facet_wrap(~Method) +
  theme(legend.position = "bottom")
```

## Condiitonal Aaverage Difference

- Causal Forestなどは、条件付き平均差 $\tau(X)$ それ自体を推定

    - Effect Riskよりも野心的な試み
    
    - 一般に信頼区間が広くなる/計算できない

## Example: Estimated CATE VS Risk

```{r}
arrow::read_parquet(
  "TempData/ResultGRF.parquet"
) |> 
  rename(
    estimate = Tau,
    std.error = SD
    ) |> 
  mutate(Method = "CausalForest") |> 
  arrange(estimate) |> 
  mutate(Q = c(1:nrow(Result))/nrow(Result)) |> 
  filter(Q >= 0.05) |> 
  bind_rows(
    map_dfr(seq(0.05,1,0.05),
        EstSuperLearner
        )
  ) |> 
  ggplot(
    aes(x = Q,
        y = estimate,
        ymin = estimate - CI*std.error,
        ymax = estimate + CI*std.error
        )
    ) +
  theme_bw() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_ribbon(
    aes(
      ymin = estimate - 1.96*std.error,
      ymax = estimate + 1.96*std.error,
      fill = "NonAdjusted CI"),
    alpha = 0.5
    ) +
  facet_wrap(~Method) +
  theme(legend.position = "bottom")
```

## Classification Analysis

- 顕著な異質性を持つ集団はどのようなものか？

- @chernozhukov2020generic

$$CLAN=E[X_l|s(X)\le Q(s(X),q)]$$

$$-E[X_l|s(X) > Q(s(X),q)]$$

- $s(X)$ は所与（よくわからんルール）

## Example: CLAN

```{r}
Q <- qnorm(1 - (0.05/(2*9)))

EstCLAN <- function(Y){
  Temp <- fixest::feols(
    Y ~ D,
    tibble(
      Y = Y,
      D = if_else(
        Result$PredSL <=
          quantile(Result$PredSL,0.05),
        1,
        0
        )
      )
    ) |> 
    generics::tidy() |> 
    filter(term == "D") |> 
    mutate(Method = "Stacking") |> 
    bind_rows(
      fixest::feols(
        Y ~ D,
        tibble(
          Y = Y,
          D = if_else(
            Result$PredLinear <=
              quantile(Result$PredLinear,0.05),
            1,
            0)
          )
        ) |> 
    generics::tidy() |> 
    filter(term == "D") |> 
    mutate(Method = "Linear")
    ) |> 
    bind_rows(
      fixest::feols(Y ~ D,
                    tibble(
                      Y = Y,
                      D = if_else(
                        Result$PredTree <=
                          quantile(Result$PredTree,0.05),
                        1,
                        0)
                      )
                    ) |> 
        generics::tidy() |>
        filter(term == "D") |> 
        mutate(Method = "Tree")
      )
  return(Temp)
  }

EstCLAN(
  Result$Distance
  ) |> 
  mutate(term = "Distance") |> 
  bind_rows(
    EstCLAN(
      Result$Kenpei
      ) |> 
      mutate(term = "Kenpei")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$Reform
      ) |> 
      mutate(term = "Reform")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$Size
      ) |> 
      mutate(term = "Size")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$Tenure
      ) |> 
      mutate(term = "Tenure")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$Youseki
      ) |> 
      mutate(term = "Youseki")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$ZoneCommerce
      ) |> 
      mutate(term = "ZoneCommerce")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$ZoneHouse
      ) |> 
      mutate(term = "ZoneHouse")
    ) |> 
  bind_rows(
    EstCLAN(
      Result$ZoneFactory
      ) |> 
      mutate(term = "ZoneFactory")
    ) |> 
  ggplot(
    aes(
      y = term,
      x = estimate,
      xmin = estimate - Q*std.error,
      xmax = estimate + Q*std.error,
      color = Method
    )
  ) +
  theme_bw() +
  geom_vline(xintercept = 0) +
  geom_pointrange() +
  theme(legend.position = "bottom") +
  ylab("")
```

## 個人効果への含意

- 前提条件

    - 個人因果効果 $\tau_i=Y_i(1)-Y_i(0)$ が定義できる
    
    - $Y_i(d)\perp D_i|X_i=x$

- $\tau(X)$ は条件付き平均効果 $+$ 個人効果の"最善"の予測値

## 個人効果への含意

- 一般に

$$E[\tau(X)|\tau_i\le Q(\tau_i,q)]\le E[\tau(X)|\tau(X) \le Q(\tau(X),q)]$$

- 個人効果が下位q%の事例内での平均効果の上限

- $E[\tau(X)|\tau(X) \le Q(\tau(X),q)]$ が負であれば、個人効果の平均値も負


## 補論

- @kallus2022a では個人効果の上限についてのboundも議論

    - 下振れではなく上振れについても容易に応用可能
    
    - 一番シンプルなのは、$D=1$ をコントロールとする

- Nonparametricに推定された平均差の活用例

    - 個人効果の予測精度: @yadlowsky2021
    
    - grfに実装ずみ

## まとめ

- "効果の異質性分析"はふんわりワード

    - もう少しシャープに関心を絞り込む
    
- Conditioanl Average Differenceを推定し

    - 予測に使いたい? (grf)
    
    - 記述モデルを推定したい? (BLP)
    
    - 顕著な異質性を持つグループを探索したい? (Treatment Effect Risk)

- 野心的な目標(予測)にはそれ相応のコスト(大きな信頼区間、信頼できない区間)

## Reference

