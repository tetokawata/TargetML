---
title: "Untitled"
format: html
---

# SetUp

```{r}
pacman::p_load(
  tidyverse,
  SuperLearner,
  rpart
)

SimData <- function(i,n,s){
  set.seed(i)
  TempData <- tibble(
    X = sample(-2:2,n,replace = TRUE),
    U = rnorm(n,0,s)
  ) |> 
    mutate(
      Y = X^3 + U
    )
  return(TempData)
}

SimData(1,100,5) |> 
  ggplot(
    aes(
      x = X,
      y = Y
    )
  ) +
  theme_bw() +
  geom_point()

SimEst <- function(i,n,s){
  TempData <- SimData(i,n,s)
  Y <- TempData$Y
  X <- TempData |> select(X) |> mutate(X2 = X^2)
  
  TempFit <- SuperLearner(
    X = X,
    Y = Y,
    SL.library = c("SL.lm","SL.rpartPrune")
  )
  TempTestX <- tibble(X = -2) |> 
    mutate(X2 = X^2)
  TempPred <- predict(TempFit,TempTestX)
  TempResult <- tibble(
    ID = i,
    N = n,
    X = -2,
    OLS = TempPred$library.predict[,1],
    Tree = TempPred$library.predict[,2],
    SL = TempPred$pred[,1]
    ) |> 
    mutate(TrueY = X^3)
  return(TempResult)
}

map_dfr(seq(100,5000,100),function(n){SimEst(1,n,5)}) |> 
  mutate(
    TreeError = abs(Tree + 8),
    SLError = abs(SL + 8)
  ) |> 
  mutate(
    TreeError2 = TreeError^2,
    SLError2 = SLError^2
  ) |> 
  ggplot(
    aes(
      x = N,
      y = TreeError
    )
  ) +
  theme_bw() + 
  geom_line(
    aes(color = "Tree")
  )  +
  geom_line(
    aes(
      y = SLError,
      color = "SL")
  )   +
  geom_line(
    aes(
      y = SLError2,
      color = "SL2")
  )    +
  geom_line(
    aes(
      y = TreeError2,
      color = "Tree2")
  ) 
```

